<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cool & Gang Communications - Address Matching</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Cool & Gang Communications Logo" class="company-logo" onerror="this.style.display='none'">
            </div>
            <h1 class="company-name">One True Address</h1>
            <p class="subtitle"></p>
        </header>
        <main>
            <div class="two-column-layout">
                <!-- Left Column: Input and System Response -->
                <div class="left-column">
                    <div class="input-section">
                        <form id="addressForm">
                            <div class="form-group">
                                <label for="addressInput">Enter Address to Match:</label>
                                <textarea 
                                    id="addressInput" 
                                    name="address" 
                                    rows="4" 
                                    placeholder="Enter a free-form address (e.g., 123 Main St, New York, NY 10001)"
                                    required
                                ></textarea>
                            </div>
                            <button type="submit" id="submitBtn" class="submit-btn">
                                <span class="btn-text">Search For Your Address</span>
                                <span class="btn-loader" style="display: none;">Processing...</span>
                            </button>
                            <button type="button" id="doOverBtn" class="do-over-btn" style="display: none;">
                                Do Over
                            </button>
                        </form>
                    </div>

                    <div id="systemResponse" class="system-response-section" style="display: none;">
                        <h2>System Response</h2>
                        <div id="systemResponseContent"></div>
                    </div>

                    <div id="error" class="error-section" style="display: none;">
                        <h3>Error</h3>
                        <p id="errorMessage"></p>
                    </div>
                </div>

                <!-- Right Column: Matched Addresses -->
                <div class="right-column">
                    <div class="matched-addresses-header">
                        <h2>Matched Addresses</h2>
                        <div id="matchCount" class="match-count" style="display: none;"></div>
                    </div>
                    <div id="matchedAddresses" class="matched-addresses-container">
                        <div class="empty-state">
                            <p>Enter an address to see matched results here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const form = document.getElementById('addressForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoader = submitBtn.querySelector('.btn-loader');
        const doOverBtn = document.getElementById('doOverBtn');
        const systemResponseSection = document.getElementById('systemResponse');
        const systemResponseContent = document.getElementById('systemResponseContent');
        const matchedAddressesContainer = document.getElementById('matchedAddresses');
        const matchCount = document.getElementById('matchCount');
        const errorSection = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const addressInput = document.getElementById('addressInput');
            const address = addressInput.value.trim();
            
            if (!address) {
                showError('Please enter an address to match.');
                return;
            }

            // Hide previous results/errors
            systemResponseSection.style.display = 'none';
            errorSection.style.display = 'none';
            matchedAddressesContainer.innerHTML = '<div class="empty-state"><p>Processing...</p></div>';
            
            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';

            try {
                const response = await fetch('/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: address })
                });

                const data = await response.json();
                
                // Debug logging for match response
                console.log('Match Response Data:');
                console.log('  Match found:', data.match_found);
                console.log('  Matched address:', data.matched_address);
                console.log('  Pinellas matches:', data.pinellas_matches);

                if (data.success) {
                    displayResults(data);
                    doOverBtn.style.display = 'inline-block';
                } else {
                    showError(data.error || 'An error occurred while matching the address.');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        });

        doOverBtn.addEventListener('click', () => {
            // Clear the form
            form.reset();
            
            // Hide all results and errors
            systemResponseSection.style.display = 'none';
            errorSection.style.display = 'none';
            matchCount.style.display = 'none';
            doOverBtn.style.display = 'none';
            
            // Reset matched addresses container to empty state
            matchedAddressesContainer.innerHTML = '<div class="empty-state"><p>Enter an address to see matched results here.</p></div>';
            
            // Focus on the address input
            document.getElementById('addressInput').focus();
        });

        function displayResults(data) {
            // Left Column: System Response (Input, Status, Confidence, Reasoning)
            let systemHtml = '';

            systemHtml += `<div class="response-item">
                <strong>Input Address:</strong> ${escapeHtml(data.input_address)}
            </div>`;

            systemHtml += `<div class="response-item">
                <strong>Candidates Searched:</strong> ${data.candidates_searched}
            </div>`;

            if (data.match_found) {
                systemHtml += `<div class="response-item match-found">
                    <strong>Status:</strong> <span class="status-badge success">✓ Match Found</span>
                </div>`;

                systemHtml += `<div class="response-item">
                    <strong>Confidence:</strong> <span class="confidence ${getConfidenceClass(data.confidence)}">${data.confidence}%</span>
                </div>`;

                if (data.business_rule_exception) {
                    systemHtml += `<div class="response-item warning">
                        <strong>⚠️ Business Rule Exception:</strong> Confidence (${data.confidence}%) is below threshold (${data.confidence_threshold}%). This match requires manual review.
                    </div>`;
                }
            } else {
                systemHtml += `<div class="response-item match-not-found">
                    <strong>Status:</strong> <span class="status-badge error">✗ No Match Found</span>
                </div>`;

                if (data.confidence !== 'N/A') {
                    systemHtml += `<div class="response-item">
                        <strong>Confidence:</strong> <span class="confidence">${data.confidence}%</span>
                    </div>`;
                }
            }

            if (data.reasoning) {
                systemHtml += `<div class="response-item reasoning">
                    <strong>Reasoning:</strong> ${escapeHtml(data.reasoning)}
                </div>`;
            }

            systemResponseContent.innerHTML = systemHtml;
            systemResponseSection.style.display = 'block';

            // Right Column: Matched Addresses
            let addressesHtml = '';
            
            if (data.match_found && data.matched_address) {
                // Display matched address in the right column
                addressesHtml += `<div class="matched-address-card primary-match">
                    <div class="address-card-header">
                        <span class="address-number">Golden Source Match</span>
                        <span class="address-status-badge success">Matched</span>
                    </div>
                    <div class="address-card-body">`;
                
                // Display fields in specific order: address1, address2, City, state, zipcode
                // Then display any remaining fields
                const priorityFields = ['address1', 'address2', 'Mailing City', 'state', 'zipcode'];
                const displayedFields = new Set();
                
                // Field label mapping for display
                const fieldLabels = {
                    'address1': 'Address1',
                    'address2': 'Address2',
                    'Mailing City': 'City',
                    'state': 'State',
                    'zipcode': 'Zipcode'
                };
                
                // First, display priority fields in order
                for (const key of priorityFields) {
                    if (key in data.matched_address) {
                        // Use custom label or default to the key
                        const displayLabel = fieldLabels[key] || key;
                        addressesHtml += `<div class="address-detail">
                            <span class="address-label">${escapeHtml(displayLabel)}:</span>
                            <span class="address-value">${escapeHtml(data.matched_address[key] || 'N/A')}</span>
                        </div>`;
                        displayedFields.add(key);
                    }
                }
                
                // Then display all remaining fields
                for (const [key, value] of Object.entries(data.matched_address)) {
                    if (!displayedFields.has(key)) {
                        addressesHtml += `<div class="address-detail">
                            <span class="address-label">${escapeHtml(key)}:</span>
                            <span class="address-value">${escapeHtml(value || 'N/A')}</span>
                        </div>`;
                    }
                }
                
                addressesHtml += `</div></div>`;
                
                // Check if exact match exists
                const isExactMatch = data.exact_match_info && data.exact_match_info.is_exact_match;
                const noInternalMatch = data.no_internal_match;
                const hasSingleInternalRecord = data.pinellas_matches && data.pinellas_matches.length === 1;
                
                // Display exact match message only if found AND there's only a single internal record
                if (isExactMatch && hasSingleInternalRecord) {
                    addressesHtml += `<div class="exact-match-message">
                        <div class="exact-match-icon">✓</div>
                        <div class="exact-match-text">
                            <h3>Exact Match Found!</h3>
                            <p>The Golden Source address exactly matches an Internal Address. No update is needed.</p>
                        </div>
                    </div>`;
                }
                
                // Display Pinellas matches if available
                if (data.pinellas_matches && data.pinellas_matches.length > 0) {
                    const headerText = data.pinellas_matches.length > 1 
                        ? 'Internal Addresses - Duplicate Records found' 
                        : 'Internal Addresses';
                    addressesHtml += `<div class="pinellas-section">
                        <h3 class="pinellas-header">${headerText} (${data.pinellas_matches.length})</h3>`;
                    
                    data.pinellas_matches.forEach((addr, index) => {
                        addressesHtml += `<div class="matched-address-card pinellas-match">
                            <div class="address-card-header">
                                <span class="address-number">${index + 1}</span>
                            </div>
                            <div class="address-card-body">`;
                        
                        for (const [key, value] of Object.entries(addr)) {
                            addressesHtml += `<div class="address-detail">
                                <span class="address-label">${escapeHtml(key)}:</span>
                                <span class="address-value">${escapeHtml(value || 'N/A')}</span>
                            </div>`;
                        }
                        
                        addressesHtml += `</div></div>`;
                    });
                    
                    addressesHtml += `</div>`;
                    
                    // Add "Push Updates" button if there are multiple Pinellas matches (even if one is an exact match)
                    if (data.pinellas_matches.length > 1) {
                        addressesHtml += `
                        <div class="push-updates-section">
                            <button id="pushUpdatesBtn" class="push-updates-btn">
                                <span class="btn-text">Push Updates to Internal Database</span>
                                <span class="btn-loader" style="display: none;">Processing...</span>
                            </button>
                            <p class="push-updates-info">
                                Multiple address records found. Click to consolidate and update the internal database.
                            </p>
                        </div>`;
                    }
                } else if (noInternalMatch) {
                    // No internal match found - show option to write to internal_updates
                    addressesHtml += `<div class="no-internal-match-message">
                        <div class="no-match-icon">⚠️</div>
                        <div class="no-match-text">
                            <h3>No Internal Match Found</h3>
                            <p>The Golden Source address does not match any Internal addresses. You can write this address to the Internal Updates table.</p>
                        </div>
                    </div>
                    <div class="push-updates-section">
                        <button id="writeToInternalBtn" class="push-updates-btn">
                            <span class="btn-text">Write to Internal Updates Table</span>
                            <span class="btn-loader" style="display: none;">Processing...</span>
                        </button>
                        <p class="push-updates-info">
                            Click to add this Golden Source address to team_cool_and_gang.internal_updates table.
                        </p>
                    </div>`;
                }
                
                let totalMatches = 1 + (data.pinellas_matches ? data.pinellas_matches.length : 0);
                matchCount.textContent = `${totalMatches} match${totalMatches > 1 ? 'es' : ''} found (1 Golden Source, ${data.pinellas_matches ? data.pinellas_matches.length : 0} Pinellas)`;
                matchCount.style.display = 'block';
            } else {
                addressesHtml = '<div class="empty-state"><p>No matches found.</p></div>';
                matchCount.style.display = 'none';
            }

            matchedAddressesContainer.innerHTML = addressesHtml;
            
            // Attach event listener to the "Push Updates" button if it exists
            const pushUpdatesBtn = document.getElementById('pushUpdatesBtn');
            if (pushUpdatesBtn && data.pinellas_matches) {
                // Validate that matched_address has actual content
                const hasValidAddress = data.matched_address && 
                    Object.keys(data.matched_address).length > 0 &&
                    (data.matched_address.address1 || data.matched_address.state);
                
                if (hasValidAddress) {
                    pushUpdatesBtn.addEventListener('click', async () => {
                        await handlePushUpdates(data.pinellas_matches, data.matched_address);
                    });
                } else {
                    // Disable button and show error if no valid golden source address
                    pushUpdatesBtn.disabled = true;
                    pushUpdatesBtn.title = "No valid Golden Source address available";
                    console.error("Cannot push updates: Golden Source address is missing or invalid", data.matched_address);
                }
            }
            
            // Attach event listener to the "Write to Internal" button if it exists
            const writeToInternalBtn = document.getElementById('writeToInternalBtn');
            if (writeToInternalBtn && data.matched_address) {
                writeToInternalBtn.addEventListener('click', async () => {
                    await handleWriteToInternal(data.matched_address);
                });
            }
        }
        
        async function handlePushUpdates(pinellas_matches, golden_source_address) {
            const pushUpdatesBtn = document.getElementById('pushUpdatesBtn');
            const btnText = pushUpdatesBtn.querySelector('.btn-text');
            const btnLoader = pushUpdatesBtn.querySelector('.btn-loader');
            
            // Debug logging
            console.log('Push Updates - Data being sent:');
            console.log('  Pinellas Matches:', pinellas_matches);
            console.log('  Golden Source Address:', golden_source_address);
            
            // Show loading state
            pushUpdatesBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            
            try {
                const requestData = { 
                    pinellas_matches: pinellas_matches,
                    golden_source_address: golden_source_address
                };
                
                console.log('Request payload:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch('/push_updates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    alert(`Success! ${data.message}\n\nConsolidated record has been pushed to the internal database.`);
                    
                    // Log the consolidated record
                    console.log('Consolidated Record:', data.consolidated_record);
                    
                    // Update button to show success
                    btnText.textContent = 'Updates Pushed Successfully ✓';
                    btnText.style.display = 'inline';
                    btnLoader.style.display = 'none';
                    pushUpdatesBtn.classList.add('success');
                    
                    // Display the consolidated record in the UI
                    displayConsolidatedRecord(data.consolidated_record);
                } else {
                    // Show error message
                    if (data.requires_manual_review) {
                        alert(`Manual Review Required\n\n${data.error}\n\nPlease review and update the records manually.`);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                    
                    // Reset button state
                    pushUpdatesBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnLoader.style.display = 'none';
                }
            } catch (error) {
                alert('Network error: ' + error.message);
                
                // Reset button state
                pushUpdatesBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }
        
        async function handleWriteToInternal(golden_source_record) {
            const writeToInternalBtn = document.getElementById('writeToInternalBtn');
            const btnText = writeToInternalBtn.querySelector('.btn-text');
            const btnLoader = writeToInternalBtn.querySelector('.btn-loader');
            
            // Show loading state
            writeToInternalBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            
            try {
                const response = await fetch('/write_to_internal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ golden_source_record: golden_source_record })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    alert(`Success! ${data.message}\n\nGolden Source address has been written to team_cool_and_gang.internal_updates.`);
                    
                    // Log the written record
                    console.log('Written Record:', data.written_record);
                    
                    // Update button to show success
                    btnText.textContent = 'Record Written Successfully ✓';
                    btnText.style.display = 'inline';
                    btnLoader.style.display = 'none';
                    writeToInternalBtn.classList.add('success');
                    
                    // Display the written record in the UI
                    displayWrittenRecord(data.written_record);
                } else {
                    // Show error message
                    alert(`Error: ${data.error}`);
                    
                    // Reset button state
                    writeToInternalBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnLoader.style.display = 'none';
                }
            } catch (error) {
                alert('Network error: ' + error.message);
                
                // Reset button state
                writeToInternalBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }
        
        function displayConsolidatedRecord(consolidatedRecord) {
            // Create a new section to display the consolidated record
            const pushUpdatesSection = document.querySelector('.push-updates-section');
            
            // Check if consolidated record display already exists
            let consolidatedDisplay = document.getElementById('consolidatedRecordDisplay');
            if (!consolidatedDisplay) {
                consolidatedDisplay = document.createElement('div');
                consolidatedDisplay.id = 'consolidatedRecordDisplay';
                consolidatedDisplay.className = 'consolidated-record-display';
                pushUpdatesSection.appendChild(consolidatedDisplay);
            }
            
            // Build the HTML for the consolidated record
            let recordHtml = `
                <div class="consolidated-record-header">
                    <h4>✓ Consolidated Record Pushed to Internal Database</h4>
                </div>
                <div class="consolidated-record-body">`;
            
            for (const [key, value] of Object.entries(consolidatedRecord)) {
                recordHtml += `
                    <div class="consolidated-detail">
                        <span class="consolidated-label">${escapeHtml(key)}:</span>
                        <span class="consolidated-value">${escapeHtml(value || 'N/A')}</span>
                    </div>`;
            }
            
            recordHtml += `</div>`;
            consolidatedDisplay.innerHTML = recordHtml;
            
            // Scroll to the consolidated record display
            consolidatedDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function displayWrittenRecord(writtenRecord) {
            // Create a new section to display the written record
            const pushUpdatesSection = document.querySelector('.push-updates-section');
            
            // Check if written record display already exists
            let writtenDisplay = document.getElementById('writtenRecordDisplay');
            if (!writtenDisplay) {
                writtenDisplay = document.createElement('div');
                writtenDisplay.id = 'writtenRecordDisplay';
                writtenDisplay.className = 'consolidated-record-display';
                pushUpdatesSection.appendChild(writtenDisplay);
            }
            
            // Build the HTML for the written record
            let recordHtml = `
                <div class="consolidated-record-header">
                    <h4>✓ Golden Source Record Written to Internal Updates</h4>
                </div>
                <div class="consolidated-record-body">`;
            
            for (const [key, value] of Object.entries(writtenRecord)) {
                recordHtml += `
                    <div class="consolidated-detail">
                        <span class="consolidated-label">${escapeHtml(key)}:</span>
                        <span class="consolidated-value">${escapeHtml(value || 'N/A')}</span>
                    </div>`;
            }
            
            recordHtml += `</div>`;
            writtenDisplay.innerHTML = recordHtml;
            
            // Scroll to the written record display
            writtenDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
            errorSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 90) return 'high';
            if (confidence >= 70) return 'medium';
            if (confidence >= 50) return 'low';
            return 'very-low';
        }
    </script>
</body>
</html>

